<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed | Barter Your Skills</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(120deg, #f8fafc 0%, #e0c3fc 100%);
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .feed-container {
      max-width: 1400px;
      margin: 24px auto;
      padding: 0 0px;
    }
    h1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
    }
    .messages-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #5e548e;
      color: #fff !important;
      font-weight: 700;
      font-size: 1.08rem;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      text-decoration: none;
      box-shadow: 0 2px 8px #b39ddb22;
      transition: background 0.18s;
      position: relative;
    }
    .messages-btn:hover {
      background: #7c6cc5;
    }
    .messages-btn svg {
      vertical-align: middle;
    }
    .messages-badge {
      background: #d7263d;
      color: #fff;
      font-size: 0.92rem;
      font-weight: 700;
      border-radius: 50%;
      padding: 2px 7px;
      position: absolute;
      top: -8px;
      right: -12px;
      box-shadow: 0 1px 4px #b39ddb22;
    }
    .logout-btn {
      position: absolute;
      top: 24px;
      left: 24px;
      background: #d7263d;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(215, 38, 61, 0.2);
      transition: background 0.18s, transform 0.18s;
    }
    .logout-btn:hover {
      background: #b01e33;
      transform: translateY(-1px);
    }
    .project-btn {
      position: absolute;
      top: 24px;
      right: 24px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
      transition: background 0.18s, transform 0.18s;
      z-index: 11;
    }
    .project-btn:hover {
      background: #1565c0;
      transform: translateY(-1px);
    }
    .myprofile-btn {
      position: absolute;
      top: 24px;
      right: 140px;
      background: #5e548e;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #b39ddb22;
      transition: background 0.18s, transform 0.18s;
      z-index: 11;
    }
    .myprofile-btn:hover {
      background: #7c6cc5;
      transform: translateY(-1px);
    }
    h2 {
      text-align: center;
      color: #5e548e;
      font-size: 2.2rem;
      margin-bottom: 32px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    #searchBar {
      width: 100%;
      max-width: 500px;
      display: block;
      margin: 0 auto 32px auto;
      padding: 12px 16px;
      font-size: 1.08rem;
      border-radius: 8px;
      border: 1.5px solid #b39ddb;
      box-shadow: 0 1px 4px #b39ddb11;
      outline: none;
    }
    .main-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }
    .sidebar {
      width: 320px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 18px #b39ddb11;
      padding: 28px 20px 20px 20px;
      border: 1.5px solid #e0c3fc;
      min-height: 400px;
      margin-top: 0;
    }
    .sidebar h2 {
      font-size: 1.18rem;
      color: #5e548e;
      margin-bottom: 18px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .sidebar label {
      display: block;
      margin-bottom: 10px;
      color: #5e548e;
      font-weight: 500;
      font-size: 1rem;
    }
    .sidebar select, .sidebar input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 7px;
      border: 1.5px solid #b39ddb;
      margin-bottom: 18px;
      font-size: 1rem;
      background: #f8fafc;
      outline: none;
    }
    .sidebar .sort-section {
      margin-top: 24px;
      border-top: 1px solid #e0c3fc;
      padding-top: 18px;
    }
    .feed-content {
      flex: 1 1 0;
      min-width: 0;
    }
    .profiles-grid {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    .profile-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 18px #b39ddb22;
      padding: 32px 40px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      transition: box-shadow 0.2s, transform 0.2s;
      cursor: pointer;
      border: 1.5px solid #e0c3fc;
      position: relative;
      min-height: 130px;
    }
    .profile-card:hover {
      box-shadow: 0 8px 32px #b39ddb33, 0 1.5px 8px #0001;
      transform: translateY(-4px) scale(1.03);
    }
    .profile-pic {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #b39ddb;
      background: #e0e7ff;
      margin-bottom: 0;
      margin-right: 24px;
    }
    .profile-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .profile-name {
      font-size: 1.18rem;
      font-weight: 700;
      color: #5e548e;
      margin-bottom: 0;
      text-align: left;
    }
    .profile-username, .profile-skillset, .profile-merit {
      color: #b39ddb;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-align: left;
    }
    .profile-skillset {
      margin-bottom: 10px;
      text-align: left;
    }
    .profile-skillset span {
      background: #e0e7ff;
      color: #5e548e;
      border-radius: 4px;
      padding: 2px 8px;
      margin: 0 3px 3px 0;
      font-size: 0.95rem;
      display: inline-block;
    }
    .profile-merit {
      font-size: 0.98rem;
      color: #22223b;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .profile-merit .score {
      color: #b39ddb;
      font-weight: 700;
      margin-left: 4px;
    }
    @media (max-width: 1200px) {
      .feed-container { max-width: 100vw; }
      .sidebar { width: 220px; }
      .profile-card { padding: 20px 16px; }
    }
    @media (max-width: 900px) {
      .main-layout { flex-direction: column; gap: 0; }
      .sidebar { width: 100%; margin-bottom: 24px; }
      .feed-content { width: 100%; }
    }
  </style>
</head>
<body>
  <button class="logout-btn" id="logoutBtn">Logout</button>
  <button class="invitation-btn" id="invitationBtn" style="position:absolute;top:24px;left:120px;background:#ff9800;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:0.95rem;font-weight:600;cursor:pointer;box-shadow:0 2px 8px #ff980022;z-index:11;">Invitations</button>
  <button class="project-btn" id="projectBtn">Project</button>
  <button class="myprofile-btn" id="myProfileBtn">My Profile</button>
  <div class="feed-container">
    <h1>
      <a href="#" id="messagesLink" class="messages-btn">
        <svg width="22" height="22" fill="#fff" viewBox="0 0 24 24"><path d="M20 2H4C2.897 2 2 2.897 2 4v16c0 1.103 0.897 2 2 2h16c1.103 0 2-0.897 2-2V4C22 2.897 21.103 2 20 2zM20 4v0.511l-8 6.222-8-6.222V4H20zM4 20V6.489l7.445 5.792c0.36 0.28 0.75 0.419 1.14 0.419s0.78-0.139 1.14-0.419L20 6.489V20H4z"/></svg>
        Messages
        <span class="messages-badge" id="messagesBadge" style="display:none;">0</span>
      </a>
      Find People to Barter Skills
    </h1>
    <div class="main-layout">
      <aside class="sidebar">
        <h2>Categories</h2>
        <label for="serviceSelect">Service</label>
        <select id="serviceSelect">
          <option value="">All Services</option>
          <option value="Website Building">Website Building</option>
          <option value="Design Consultation">Design Consultation</option>
          <option value="Branding">Branding</option>
          <option value="App Development">App Development</option>
          <option value="Finance">Finance</option>
        </select>
        <label for="skillSelect">Skill</label>
        <select id="skillSelect">
          <option value="">All Skills</option>
          <option value="Web Development">Web Development</option>
          <option value="UI/UX Design">UI/UX Design</option>
          <option value="JavaScript">JavaScript</option>
          <option value="Photoshop">Photoshop</option>
          <option value="SEO">SEO</option>
          <option value="Flutter">Flutter</option>
          <option value="Excel">Excel</option>
        </select>
        <div class="sort-section">
          <h2>Sort By</h2>
          <select id="sortSelect">
            <option value="">Default</option>
            <option value="merit">Merit Score</option>
            <option value="rating">Ratings</option>
          </select>
        </div>
      </aside>
      <div class="feed-content">
        <input type="text" id="searchBar" placeholder="Search by name, username, skill, or service..." />
        <div class="profiles-grid" id="profilesGrid">
          <!-- Profiles will be injected here -->
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Supabase client setup
    const supabaseUrl = 'https://uyifmxtmfqlojodlrmzu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5aWZteHRtZnFsb2pvZGxybXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1OTkzOTYsImV4cCI6MjA2NzE3NTM5Nn0.flAP_CN8tbXFLlIYJ6QkZapHC_ceqgnAb7XEIJ0IkyY';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let profiles = [];
    function ensureCurrentUser() {
      let currentUser = localStorage.getItem('currentUser');
      if (!currentUser) {
        document.getElementById('profilesGrid').innerHTML = '<div style="color:#b39ddb;text-align:center;font-size:1.2rem;">Please log in to view the feed.</div>';
        return null;
      }
      return currentUser.trim().toLowerCase();
    }

    async function fetchProfiles() {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .order('name', { ascending: true });

      if (error) {
        grid.innerHTML = `<div style=\"color:red;\">Failed to load profiles: ${error.message}</div>`;
        return;
      }

      // Always ensure currentUser is set and normalized
      let currentUser = ensureCurrentUser();
      if (!currentUser) return;
      profiles = (data || [])
        .filter(profile => {
          if (!profile.username) return true;
          // Always compare normalized
          return profile.username.trim().toLowerCase() !== currentUser;
        })
        .map(profile => ({
          name: profile.name || '',
          username: profile.username || '',
          pic: profile.pic || `https://randomuser.me/api/portraits/lego/${Math.floor(Math.random()*10)+1}.jpg`,
          skillset: Array.isArray(profile.skill_set) ? profile.skill_set : (profile.skill_set ? profile.skill_set.split(',').map(s=>s.trim()) : []),
          services: Array.isArray(profile.services_provided) ? profile.services_provided : (profile.services_provided ? profile.services_provided.split(',').map(s=>s.trim()) : []),
          merit: typeof profile.merit === 'number' ? profile.merit : 100,
          rating: typeof profile.rating === 'number' ? profile.rating : 0
        }));

      filterAndSortProfiles();
    }
    

    const grid = document.getElementById('profilesGrid');
    const searchBar = document.getElementById('searchBar');
    const serviceSelect = document.getElementById('serviceSelect');
    const skillSelect = document.getElementById('skillSelect');
    const sortSelect = document.getElementById('sortSelect');

    function renderProfiles(filteredProfiles) {
      grid.innerHTML = '';
      filteredProfiles.forEach(profile => {
        const card = document.createElement('div');
        card.className = 'profile-card';
        card.onclick = (e) => {
          // Only trigger if not clicking DM button
          if (e.target.classList.contains('dm-btn')) return;
          window.location.href = `/profile/profile.html?user=${profile.username}`;
        };
        card.innerHTML = `
          <img class="profile-pic" src="${profile.pic}" alt="${profile.name}">
          <div class="profile-details">
            <div class="profile-name">${profile.name}</div>
            <div class="profile-username">@${profile.username}</div>
            <div class="profile-skillset">
              ${profile.skillset.map(skill => `<span>${skill}</span>`).join(' ')}
            </div>
            <div class="profile-merit">Merit Score: <span class="score">${profile.merit}</span> | Rating: <span class="score">${profile.rating}</span></div>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    // Start DM with a user
    function startDM(username) {
      let currentUser = localStorage.getItem('currentUser');
      if (!currentUser) {
        document.getElementById('profilesGrid').innerHTML = '<div style="color:#b39ddb;text-align:center;font-size:1.2rem;">Please log in to start a DM.</div>';
        return;
      }
      // Go to messages.html with the other user
      window.location.href = `messages.html?user=${username}`;
    }

    function filterAndSortProfiles() {
      const query = searchBar.value.trim().toLowerCase();
      const selectedService = serviceSelect.value;
      const selectedSkill = skillSelect.value;
      const sortBy = sortSelect.value;
      let filtered = profiles.filter(profile => {
        const matchesQuery =
          !query ||
          profile.name.toLowerCase().includes(query) ||
          profile.username.toLowerCase().includes(query) ||
          profile.skillset.some(skill => skill.toLowerCase().includes(query)) ||
          profile.services.some(service => service.toLowerCase().includes(query));
        const matchesService = !selectedService || profile.services.includes(selectedService);
        const matchesSkill = !selectedSkill || profile.skillset.includes(selectedSkill);
        return matchesQuery && matchesService && matchesSkill;
      });
      if (sortBy === 'merit') {
        filtered = filtered.sort((a, b) => b.merit - a.merit);
      } else if (sortBy === 'rating') {
        filtered = filtered.sort((a, b) => b.rating - a.rating);
      }
      renderProfiles(filtered);
    }

    // Initial render
    fetchProfiles();

    searchBar.addEventListener('input', filterAndSortProfiles);
    serviceSelect.addEventListener('change', filterAndSortProfiles);
    skillSelect.addEventListener('change', filterAndSortProfiles);
    sortSelect.addEventListener('change', filterAndSortProfiles);

    // Messages button in header: open messages page for current user
    document.getElementById('messagesLink').addEventListener('click', function(e) {
      e.preventDefault();
      let currentUser = localStorage.getItem('currentUser');
      if (!currentUser) {
        alert('Please log in to view your messages.');
        return;
      }
      window.location.href = `messages.html`;
    });

    // Dummy unanswered DMs count
    const unansweredDMs = 3; // Replace with real value from backend
    const badge = document.getElementById('messagesBadge');
    if (unansweredDMs > 0) {
      badge.textContent = unansweredDMs;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', function() {
      // Clear any stored user data
      localStorage.removeItem('currentUser');
      // Redirect to login page
      window.location.href = '/index.html';
    });

    document.getElementById('projectBtn').addEventListener('click', function() {
      window.location.href = '../projects/projects.html';
    });

    document.getElementById('myProfileBtn').addEventListener('click', function() {
      let currentUser = localStorage.getItem('currentUser');
      if (!currentUser) {
        alert('Please log in to view your profile.');
        return;
      }
      window.location.href = `/profile/profile.html?user=${encodeURIComponent(currentUser)}`;
    });

    document.getElementById('invitationBtn').addEventListener('click', function() {
      window.location.href = 'invitation.html';
    });
  </script>
</body>
</html>